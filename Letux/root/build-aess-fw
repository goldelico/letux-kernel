#!/bin/bash
#
# build AESS firmware on destination device (e.g. PandaBoard, OMAP5EVM, Pyra, ...)
# cross-compile may need different approach
# tested on Debian 9.13
#
# Firware comes from https://github.com/omap-audio
#
# Caveats:
# - we have no idea where to find audio-test.git
# - the tests subdirectory assumes headers and constants (e.g. OMAP_ABE_DMEM)
# - these are nowhere available on an upstream Linux kernel
# - some location is e.g. https://android.googlesource.com/kernel/msm/+/android-msm-mako-3.4-jb-mr1.1/sound/soc/omap/abe/abe_mem.h
# - so we mix the letux kernel tree (headers) with this stuff
#

THIS="$PWD"
BRANCH=letux-5.16-rc8
VERSION=009590

#
# preparation of build host
#

echo +++ make sure we have the required build tools
apt-get install build-essential bison flex bc libssl-dev git autogen automake libtool || exit 1

echo +++ create and go to $PWD/aess
mkdir -p aess && cd aess || exit 1

#
# getting source trees
#

function gitfetch { # $1 = repo, $2 = subdir
	if ! [ -d $2 ]
	then
		rm -rf $2.tmp
		git clone --depth 1 -b $BRANCH $1 $2.tmp && mv $2.tmp $2 || return
	fi
}

echo +++ fetch the "(complete)" letux kernel source tree with minimal effort
gitfetch "--depth 1 -b $BRANCH https://github.com/goldelico/letux-kernel.git" letux-kernel.git || exit 1

LETUX="$PWD/letux-kernel.git"	# full source tree
LINUX="$PWD/linux-headers"	# installed headers

echo +++ fetch the omap4/5 firmware into a subdirectory
gitfetch "-b master https://github.com/omap-audio/abefw" abefw.git || exit 1

echo +++ fetch the audio-test code
gitfetch "-b master https://github.com/omap-audio/audio-test.git" audio-test.git

echo +++ fetch the asoc-fw tools
gitfetch "-b master https://github.com/omap-audio/asoc-fw.git" asoc-fw.git

#
# build kernel headers
#

echo +++ configure kernel and build generated headers
[ -f $LETUX/include/generated/uapi/linux/version.h ] || (cd $LETUX && make ARCH=arm letux_lpae_defconfig modules_prepare headers_install INSTALL_HDR_PATH=$LINUX && ln -sf asm-generic include/asm) || exit 1

#
# patch and build firmware
# NOTE: we should better fork the firmware repo and add a proper patch set...
#

(
cd abefw.git || exit

#echo +++ merge hack with HAL source "(we have not found a good and modern git repo)"
#[ -d letux-kernel.git/sound/soc/ti/abe ] || wget -O - https://android.googlesource.com/kernel/msm/+archive/529e46df76c9818f5e86ffe438d60c735e6e60cc.tar.gz |
#		(cd letux-kernel.git && tar xvzf - sound/soc/omap/abe --transform='s|/omap/|/ti/|' ) || exit 1

echo +++ modern kernel has replaced sound/soc/omap by sound/soc/ti
find tasks -type f -a ! -name '*.bak' -exec fgrep -q soc/omap {} \; -exec sed -i.bak 's|soc/omap|soc/ti|g' {} \;

echo +++ work around type conflicts between kernel source and /usr/include/stdint.h for uintptr_t or dev_t
fgrep -q host_uintptr_t src/abegen.h || sed -i.bak -e "s/#define __ABEGEN_H/#define __ABEGEN_H\n#define uintptr_t host_uintptr_t/" src/abegen.h
fgrep -q _SYS_TYPES_H tasks/009590/abe_asrc.c || sed -i.bak -e "s/#include <stddef.h>/#define _SYS_TYPES_H 1\n#include <stddef.h>/" tasks/009590/abe_asrc.c


echo +++ modern kernel has renamed some constants from ABE to AESS
#### falsch!!! abe_addr.c macht einen #include <abe_initxxx_labels.h> wo MM_DL_44P1_WPTR_labelID eigentlich drin sein sollte
# (nicht OMAP_AESS_PORT_)
# aber die Suchpfade stimmen nicht
#sed -i.bak -e 's/OMAP_AESS_PORT_/OMAP_AESS_PROTOCOL_/' \
#	    -e 's/MM_DL_44P1_WPTR_labelID/OMAP_AESS_SMEM_MM_DL_44P1_ID/' \
#	tasks/009590/abe_addr.c

# NOTE: modern aess-fw has no serial/dmareq ports...
sed -i.bak -e "s/OMAP_ABE_DMEM/OMAP_AESS_BANK_DMEM/" \
	   -e "s/OMAP_ABE_CMEM/OMAP_AESS_BANK_CMEM/" \
	   -e "s/OMAP_ABE_SMEM/OMAP_AESS_BANK_SMEM/" \
	   -e "s/OMAP_ABE_PORT_ACTIVITY_IDLE/OMAP_AESS_PORT_ACTIVITY_IDLE/" \
	   -e "s/OMAP_AESS_PORT_DMIC/OMAP_AESS_PHY_PORT_DMIC/" \
	   -e "s/OMAP_AESS_PORT_MCPDMUL/OMAP_AESS_PHY_PORT_PDM_UL/" \
	   -e "s/OMAP_AESS_PORT_MCPDMDL/OMAP_AESS_PHY_PORT_PDM_DL/" \
	   -e "s/OMAP_AESS_PORT_SERIAL/OMAP_AESS_LAST_PHY_PORT_ID/" \
	   -e "s/OMAP_AESS_PORT_DMAREQ/OMAP_AESS_LAST_PHY_PORT_ID/" \
	   -e "s/LAST_PORT_ID/OMAP_AESS_LAST_PHY_PORT_ID/" \
	   -e "s/ABE_DMASTATUS_RAW/AESS_DMASTATUS_RAW/" \
	tasks/009590/abe_addr.c
sed -i.bak -e "s/OMAP_ABE_VX_DL_PORT/OMAP_AESS_PHY_PORT_VX_DL/" \
	   -e "s/OMAP_ABE_VX_UL_PORT/OMAP_AESS_PHY_PORT_VX_UL/" \
	   -e "s/OMAP_ABE_BT_VX_UL_PORT/OMAP_AESS_PHY_PORT_BT_VX_UL/" \
	   -e "s/OMAP_ABE_BT_VX_DL_PORT/OMAP_AESS_PHY_PORT_BT_VX_DL/" \
	tasks/009590/abe_asrc.c

#echo +++ modern kernel already defines some constants in aess-fw.h which conflict with older abe_def.h and elsewhere
#sed -i.bak -e "s/#define CIRCULAR_BUFFER_PERIPHERAL_R__.*//" \
#	   -e "s/#define SRC_P .*//" \
#	   -e "s/#define SNK_P .*//" \
#	   -e "s/#define SRC_P .*//" \
#	   -e "s/#define SABE_TASK_ID_.*//" \
#	$LINUX/sound/soc/ti/abe/abe_def.h
#sed -i.bak -e "s/#define FEAT_.*//" $LINUX/sound/soc/ti/abe/abe_typ.h
#sed -i.bak -e "s/#define ABE_TASK_ID.*//" $LINUX/sound/soc/ti/abe/abe_api.h

#echo +++ append some central includes which are not included otherwise
#fgrep -q abe_api include/009590/abe_define.h || echo "#include <abe_api.h>
##include <abe_def.h>
##include <abe_mem.h>" >>include/009590/abe_define.h

echo +++ script assumes a different location of kernel sources in $HOME/source/linux.git
sed -i.bak "s|~/source/linux.git|$LETUX|g" scripts/abe-tool.sh

echo +++ fix automake for subdir-objects
sed -i.bak 's|no-define dist-bzip2|no-define subdir-objects dist-bzip2|g' configure.ac

echo +++ build the Makefiles
LC_ALL=C ./autogen.sh || exit 1

echo +++ avoid ./configure: line 4646: CC_NOUNDEFINED: command not found
sed -i.bak 's|CC_NOUNDEFINED||g' configure

echo +++ configure
# the configure option --with-hal-dir does not exist "(contrary to README)"
# ./configure --with-linux-dir=$LETUX --with-hal-dir=$PWD/hal || exit 1
./configure --with-linux-dir=$LETUX || exit 1

echo +++ patch include file search paths and some compiler options
# typical kernel gcc call: arm-linux-gnueabihf-gcc -Wp,-MMD,arch/arm/kernel/.perf_regs.o.d  -nostdinc -I./arch/arm/include -I./arch/arm/include/generated  -I./include -I./arch/arm/include/uapi -I./arch/arm/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/compiler-version.h -include ./include/linux/kconfig.h -include ./include/linux/compiler_types.h -D__KERNEL__ -mlittle-endian -Wall -Wundef -Werror=strict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -Werror=implicit-function-declaration -Werror=implicit-int -Werror=return-type -Wno-format-security -std=gnu89 -fno-dwarf2-cfi-asm -fno-ipa-sra -mabi=aapcs-linux -mfpu=vfp -funwind-tables -mtp=cp15 -marm -Wa,-mno-warn-deprecated -D__LINUX_ARM_ARCH__=7 -march=armv7-a -msoft-float -Uarm -fno-delete-null-pointer-checks -Wno-frame-address -Os --param=allow-store-data-races=0 -Wframe-larger-than=1024 -fstack-protector-strong -Wno-main -Wno-unused-but-set-variable -Wno-unused-const-variable -fomit-frame-pointer -fno-inline-functions-called-once -Wdeclaration-after-statement -Wvla -Wno-pointer-sign -Wno-array-bounds -Wno-maybe-uninitialized -fno-strict-overflow -fno-stack-check -fconserve-stack -Werror=date-time -Werror=incompatible-pointer-types -Werror=designated-init    -DKBUILD_MODFILE='"arch/arm/kernel/perf_regs"' -DKBUILD_BASENAME='"perf_regs"' -DKBUILD_MODNAME='"perf_regs"' -D__KBUILD_MODNAME=kmod_perf_regs -c -o arch/arm/kernel/perf_regs.o arch/arm/kernel/perf_regs.c
# include linux headers
INCLUDES+=" -I $PWD//arch/arm/include"
INCLUDES+=" -I $LETUX/arch/arm/include/generated"
INCLUDES+=" -I $LETUX/include"
INCLUDES+=" -I $LETUX/arch/arm/include/uapi"
INCLUDES+=" -I $LETUX/arch/arm/include/generated/uapi"
INCLUDES+=" -I $LETUX/include/uapi"
INCLUDES+=" -I $LETUX/include/generated/uapi"
INCLUDES+=" -include $LETUX/include/linux/compiler-version.h"
INCLUDES+=" -include $LETUX/include/linux/kconfig.h"
INCLUDES+=" -include $LETUX/include/linux/compiler_types.h"
INCLUDES+=" -include $LETUX/include/linux/types.h"
INCLUDES+=" -D__KERNEL__"
# -mlittle-endian -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE
# -mabi=aapcs-linux -mfpu=vfp -funwind-tables -mtp=cp15 -marm
INCLUDES+=" -D__LINUX_ARM_ARCH__=7"
# -march=armv7-a -msoft-float -Uarm -fno-delete-null-pointer-checks -Os
# INCLUDES+=" -D__ASSEMBLY__"
# INCLUDES+=" -DARCH=arm"
# the following is the result of experimentation
#INCLUDES+=" -I ../include"
#INCLUDES+=" -I ."
#INCLUDES+=" -I $PWD/include/$VERSION"
INCLUDES+=" -I $PWD/tasks"
#INCLUDES+=" -I $PWD/../audio-test/tools/abe/abe_hal"	# for abe_api.h
# try fine control over system headers which may conflict with linux kernel tree headers
if false
then
INCLUDES+=" -nostdinc"
INCLUDES+=" -I /usr/lib/gcc/arm-linux-gnueabihf/6/include"
INCLUDES+=" -I /usr/local/include"
INCLUDES+=" -I /usr/lib/gcc/arm-linux-gnueabihf/6/include-fixed"
INCLUDES+=" -I /usr/include/arm-linux-gnueabihf"
INCLUDES+=" -I /usr/include"
fi

# we misuse this line for all the CFLAGS...
sed -i.bak "s|DEFAULT_INCLUDES =.*|DEFAULT_INCLUDES =$INCLUDES|g" tasks/Makefile

echo +++ make and install
make || exit 1
make install || exit 1

echo +++ generate data files
scripts/abe-tool.sh $VERSION || exit 1
) || exit

(
cd asoc-fw.git || exit

#echo +++ work around type conflicts between kernel source and /usr/include/stdint.h for uintptr_t or dev_t
#fgrep -q host_uintptr_t src/abegen.h || sed -i.bak -e "s/#define __ABEGEN_H/#define __ABEGEN_H\n#define uintptr_t host_uintptr_t/" src/abegen.h
fgrep -q _SYS_TYPES_H src/lib.c || sed -i.bak -e "s/#include <stdlib.h>/#define _SYS_TYPES_H 1\n#include <stdlib.h>/" src/lib.c
fgrep -q '#undef' src/lib.c || sed -i.bak -e "s/#include <stdlib.h>/typedef int int32_t;\n#include <stdlib.h>\n#undef __always_inline\n#undef __extern_always_inline\n#undef __attribute_const__/" src/lib.c
fgrep -q '#include <sound/soc-dapm.h>' src/socfw.h || sed -i.bak -e "s|int8_t s8;|int8_t s8;\n\n#include <sound/soc-dapm.h>|" src/socfw.h

# src/lib.c verwendet viele undefined wie z.B. SND_SOC_FW_TEXT_SIZE, SOC_CONTROL_ID, SOC_CONTROL_GET_ID_GET, SOC_CONTROL_TYPE_VOLSW_SX...
# war das früher im Kernel definiert?
# angeblich ja (applied): https://alsa-devel.alsa-project.narkive.com/3d94ItQx/patch-1-4-asoc-firmware-add-support-for-fw-based-kcontrols
# https://mailman.alsa-project.org/pipermail/alsa-devel/2012-November/057156.html

echo +++ build the Makefiles
LC_ALL=C ./autogen.sh || exit

echo +++ configure
./configure --with-linux-dir=$LINUX --enable-omap4 || exit

echo +++ patch include file search paths and some compiler options
# typical kernel gcc call: arm-linux-gnueabihf-gcc -Wp,-MMD,arch/arm/kernel/.perf_regs.o.d  -nostdinc -I./arch/arm/include -I./arch/arm/include/generated  -I./include -I./arch/arm/include/uapi -I./arch/arm/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/compiler-version.h -include ./include/linux/kconfig.h -include ./include/linux/compiler_types.h -D__KERNEL__ -mlittle-endian -Wall -Wundef -Werror=strict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -Werror=implicit-function-declaration -Werror=implicit-int -Werror=return-type -Wno-format-security -std=gnu89 -fno-dwarf2-cfi-asm -fno-ipa-sra -mabi=aapcs-linux -mfpu=vfp -funwind-tables -mtp=cp15 -marm -Wa,-mno-warn-deprecated -D__LINUX_ARM_ARCH__=7 -march=armv7-a -msoft-float -Uarm -fno-delete-null-pointer-checks -Wno-frame-address -Os --param=allow-store-data-races=0 -Wframe-larger-than=1024 -fstack-protector-strong -Wno-main -Wno-unused-but-set-variable -Wno-unused-const-variable -fomit-frame-pointer -fno-inline-functions-called-once -Wdeclaration-after-statement -Wvla -Wno-pointer-sign -Wno-array-bounds -Wno-maybe-uninitialized -fno-strict-overflow -fno-stack-check -fconserve-stack -Werror=date-time -Werror=incompatible-pointer-types -Werror=designated-init    -DKBUILD_MODFILE='"arch/arm/kernel/perf_regs"' -DKBUILD_BASENAME='"perf_regs"' -DKBUILD_MODNAME='"perf_regs"' -D__KBUILD_MODNAME=kmod_perf_regs -c -o arch/arm/kernel/perf_regs.o arch/arm/kernel/perf_regs.c
# include linux headers
#INCLUDES+=" -I $LETUX/arch/arm/include"
#INCLUDES+=" -I $LETUX/arch/arm/include/generated"
#INCLUDES+=" -I $LETUX/include"
#INCLUDES+=" -I $LETUX/arch/arm/include/uapi"
#INCLUDES+=" -I $LETUX/arch/arm/include/generated/uapi"
#INCLUDES+=" -I $LETUX/include/uapi"
#INCLUDES+=" -I $LETUX/include/generated/uapi"
INCLUDES+=" -D__KERNEL__"
# -mlittle-endian -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE
# -mabi=aapcs-linux -mfpu=vfp -funwind-tables -mtp=cp15 -marm
INCLUDES+=" -D__LINUX_ARM_ARCH__=7"
#INCLUDES+=" -D__LINUX_COMPILER_ATTRIBUTES_H"
#INCLUDES+=" -D_SYS_CDEFS_H"
INCLUDES+=" -D_SYS_STAT_H"
#INCLUDES+=" -D_FCNTL_H"
# -march=armv7-a -msoft-float -Uarm -fno-delete-null-pointer-checks -Os
# INCLUDES+=" -D__ASSEMBLY__"
# INCLUDES+=" -DARCH=arm"
# the following is the result of experimentation
#INCLUDES+=" -I ../include"
#INCLUDES+=" -I ."
#INCLUDES+=" -I $PWD/include/$VERSION"
#INCLUDES+=" -I $PWD/tasks"
#INCLUDES+=" -I $PWD/../audio-test/tools/abe/abe_hal"	# for abe_api.h
# try fine control over system headers which may conflict with linux kernel tree headers
if false
then
INCLUDES+=" -nostdinc"
INCLUDES+=" -I /usr/lib/gcc/arm-linux-gnueabihf/6/include"
INCLUDES+=" -I /usr/local/include"
INCLUDES+=" -I /usr/lib/gcc/arm-linux-gnueabihf/6/include-fixed"
INCLUDES+=" -I /usr/include/arm-linux-gnueabihf"
INCLUDES+=" -I /usr/include"
fi
# include some relevant kernel files
#INCLUDES+=" -include $LETUX/include/linux/compiler-version.h"
#INCLUDES+=" -include $LETUX/include/linux/kconfig.h"
#INCLUDES+=" -include $LETUX/include/linux/compiler_types.h"
#INCLUDES+=" -include $LETUX/include/linux/types.h"
INCLUDES+=" -I $LINUX/include"
# include some headers usually not exported from source tree
#INCLUDES+=" -include $LETUX/include/linux/compiler_types.h"
#INCLUDES+=" -include $LETUX/include/linux/compiler.h"
### FIXME: how can we skip include <linux/nospec.h> in include/sound/control.h
### by creating an empty linux/nospec.h in the search path
#INCLUDES+=" -D_LINUX_NOSPEC_H"
INCLUDES+=" -D__user=''"
INCLUDES+=" -D_LINUX_WAIT_H"
# define some minimalistic private headers so that we do not include the full kernel tree
# if we would include the full kernel tree we will get conficts about dev_t and other types
mkdir -p src/linux src/sound	# there is -I ../src
### sound/control.h and others needs list_head
(
echo "#ifndef _LINUX_LIST_H"
echo "#define _LINUX_LIST_H"
echo "struct list_head { struct list_head *next, *prev; };"
echo "#endif"
) >src/linux/list.h
(
echo "#ifndef _LINUX_NOSPEC_H"
echo "#define _LINUX_NOSPEC_H"
echo "#include <linux/list.h>"
echo "typedef int wait_queue_head_t;"
echo "typedef int spinlock_t;"
echo "typedef int bool;"
# assume we are on a 32 bit machine like omap4/5
echo "#define array_index_nospec(A, B) (0*A*B)"
echo "#define IS_MODULE(A) (0)"
echo "struct snd_pcm_substream { };"
echo "struct dentry { };"
echo "#include \"socfw.h\""
echo "#endif"
) > src/linux/nospec.h	# do not try to include the nested file from full kernel tree
ln -sf "$LETUX/include/sound/control.h" src/sound
ln -sf "$LETUX/include/sound/soc-topology.h" src/sound
ln -sf "$LETUX/include/sound/soc-dapm.h" src/sound
# INCLUDES+=" -include $LETUX/include/linux/nospec.h"
# INCLUDES+=" -include $LETUX/include/sound/soc-dapm.h"
# INCLUDES+=" -include $LETUX/include/sound/control.h"

# we misuse this line for all the CFLAGS...
sed -i.bak \
	-e "s|DEFAULT_INCLUDES =.*|DEFAULT_INCLUDES =$INCLUDES|g" \
	-e "s|-D __EXPORTED_HEADERS__||g" \
	src/Makefile

echo +++ make and install
make || exit 1
make install || exit 1

echo +++ generate firmware binary
scripts/abegen.sh || exit 1
) || exit
