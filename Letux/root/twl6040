#
# /root/twl6040: demo for twl6040 sound
#

trap "killall volumed" EXIT
trap "exit 1" SIGHUP SIGINT SIGTERM

FILE=somefile.mp3

while [ "$1" ]
do
        case "$1" in
        "-d" )
		DEMO=true
		;;
        "-v" )
		NOVOLUMED=true
		;;
        "-lp" )
		LPMODE=true
		;;
        "-hf" )
		NOHANDSFREE=true
		;;
	-* )
		echo unknown option $1
		exit 1
		;;
	* )
		break
		;;
	esac
	shift
done

if [ "$1" ] # given file
then
	FILE=$1
	shift
fi

if [ "$NOVOLUMED" ]
then
	: # don't start volumed
else
	/root/volumed -q &
fi

amixer -q set "Aux FM" 0% || exit
amixer -q set "Capture" 100% || exit
amixer -q set "Capture Preamplifier" 100% || exit
amixer -q set "AUXL" "off" || exit
amixer -q set "AUXR" "off" || exit
amixer -q set "Analog Left" "Main Mic" || exit
amixer -q set "Analog Right" "Headset Mic" || exit
amixer -q set "Earphone" 80% || exit
amixer -q set "Handsfree" 50% || exit

if [ "$NOHANDSFREE" ]
then
amixer -q set "Handsfree Left Playback" "HF DAC" || exit
amixer -q set "Handsfree Right Playback" "HF DAC" || exit
else
amixer -q set "Handsfree Left Playback" "Off" || exit
amixer -q set "Handsfree Right Playback" "Off" || exit
fi

amixer -q set "Headset" 80% || exit
amixer -q set "Headset Left Playback" "HS DAC" || exit
amixer -q set "Headset Right Playback" "HS DAC" || exit
amixer -q set "Analog Left" "Main Mic" || exit

if [ "$LPMODE" ] # low power mode
then
	amixer -q set "Headset Power Mode" "Low-Power" || exit
	amixer -q set "PLL Selection" "Low-Power" || exit
else
	amixer -q set "Headset Power Mode" "High-Performance" || exit
	amixer -q set "PLL Selection" "High-Performance" || exit
fi

amixer -q set "Vibra Left Playback" "Input FF" || exit
amixer -q set "Vibra Right Playback" "Input FF" || exit

: amixer -q set "Vibra Left Playback" "Audio PDM" || exit
: amixer -q set "Vibra Right Playback" "Audio PDM" || exit

[ -x /usr/bin/sox ] || apt-get install sox libsox-fmt-mp3

if [ "$DEMO" ] # demo
then
	aplay -q /usr/share/sounds/alsa/*.wav
	# play chirp sound on all 4 channels
	sox -c 4 -n -t wav - synth 10 sine 10-100 | aplay
	# remix for Pandaboard/OMAP5 stereo
	play /usr/share/sounds/alsa/Front_Center.wav remix 1 1
	# play some music file
	# headset only
	play $FILE
fi

# play on headset and main speakers
play $FILE remix 1 2 1 2
