#!/bin/bash

# by Neil Brown

# disable charging, suspend for 5 minutes and report apparent
# power usage by monitoring battery.

case $(cat /proc/device-tree/model 2>/dev/null) in
	*GTA04A5* )
		power1=/sys/class/power_supply/twl4030_usb/mode
		power2=/sys/class/power_supply/twl4030_ac/mode
		chg=/sys/class/power_supply/bq27621-0/charge_now
		alarm=/sys/class/rtc/rtc0/wakealarm
		rs232=/sys/class/gpio/gpio13/value
		rs232dir=/sys/class/gpio/gpio13/direction
		echo heartbeat >/sys/class/leds/gta04:green:aux/trigger
		[ -f $rs232 ] || { echo 13 > /sys/class/gpio/export; echo high > $rs232dir;}
		;;
	*GTA04* )
		power1=/sys/class/power_supply/twl4030_usb/mode
		power2=/sys/class/power_supply/twl4030_ac/mode
		chg=/sys/class/power_supply/bq27000-battery/charge_now
		alarm=/sys/class/rtc/rtc0/wakealarm
		rs232=/sys/class/gpio/gpio13/value
		rs232dir=/sys/class/gpio/gpio13/direction
		[ -f $rs232 ] || { echo 13 > /sys/class/gpio/export; echo high > $rs232dir;}
		;;
	*Pandora* )
		power1=/sys/class/power_supply/twl4030_usb/mode
		power2=/sys/class/power_supply/twl4030_ac/mode
		chg=/sys/class/power_supply/bq27500-0/charge_now
		alarm=/sys/class/rtc/rtc0/wakealarm
		;;
	*Pyra-Handheld* )
		# FIXME: disabling charging must be done differently
#		power1=/sys/class/power_supply/twl4030_usb/mode
#		power2=/sys/class/power_supply/twl4030_ac/mode
		chg=/sys/class/power_supply/bq27621-0/charge_now
		alarm=/sys/class/rtc/rtc0/wakealarm
		;;
	* )
		echo "unknown device $(cat /proc/device-tree/model 2>/dev/null)"
		exit 1
		;;
esac

delay=${1-300}

echo suspending for $delay seconds >&2
stty raw -echo -cread
[ "$rs232" ] && echo 0 > $rs232
[ "$power1" ] && echo off > $power1
[ "$power2" ] && echo off > $power2
before=`cat $chg`
start=`date '+%s'`
echo $[start+delay] > $alarm
echo mem > /sys/power/state
after=`cat $chg`
end=`date '+%s'`
[ "$rs232" ] && echo 1 > $rs232
stty sane
echo did wake up >&2
[ "$power1" ] && echo auto > $power1
[ "$power2" ] && echo auto > $power2

echo $[(before-after)*3600/(end-start)] uA over $[end-start] seconds