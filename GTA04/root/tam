#
# run as telephone answering machine
#
# usage: tam
#

make femtocom

for repeat in 1 2 3 4 5
	do
	if lsusb | fgrep '0af0:8800 Option' >/dev/null
		then # found
		break
	fi
	if [ -w /sys/devices/virtual/gpio/gpio186/value ]
	then # wake up modem in GTA04A4
		echo 1 >/sys/devices/virtual/gpio/gpio186/value
		sleep 1
		echo 0 >/sys/devices/virtual/gpio/gpio186/value
		sleep 5
	fi
	done

for i in $(cd /sys/class/tty/ && echo ttyHS*)
	do
	if [ "$(cat /sys/class/tty/$i/hsotype)" == "Application" ]
		then
		IF="/dev/$i"
	fi
done

[ "$IF" ] || (echo HSO Application interface not found; exit 1)

echo Interface: $IF

# make sure the PCM goes to the SoC
amixer set 'Voice route' 'Voice to SoC'

rm -rf /tmp/femtocom
mkfifo /tmp/femtocom

./femtocom $IF </tmp/femtocom |
(
echo "*** TAM starting ***"
( # enable unsolicite messages and extended reporting
echo "AT+CPIN?"; sleep 1
echo "AT_OPONI=1"; sleep 1
echo "AT_OSQI=1"; sleep 1
echo "AT_OEANT=1"; sleep 1
echo "AT_OCTI=1"; sleep 1
echo "AT_OUWCTI=1"; sleep 1
echo "AT_OUHCIP=1"; sleep 1
echo "AT_OSSYS=1"; sleep 1
echo "AT_OPATEMP=1"; sleep 1
echo "AT+COPS"; sleep 1
echo "AT+CRC=1"; sleep 1
echo "AT+CLIP=1"; sleep 1
) >/tmp/femtocom
echo "*** TAM started ***"
while read MSG ARGS
do
	[ "$MSG$ARGS" ] && echo $MSG $ARGS >&2
	case "$MSG" in
		++CLIP: )
			# decode phone number from ARGS
			echo "ATA" >/tmp/femtocom
			# arecord -fS16_LE -r8000 | aplay -Ddefault:CARD=gta04voice &	# microphone -> modem
			cat /usr/share/sounds/alsa/Front_Center.wav | aplay -Ddefault:CARD=gta04voice &	# file -> modem
			# arecord -Ddefault:CARD=gta04voice -fS16_LE -r8000 | aplay	# modem -> earpiece, speaker, headset
			arecord -Ddefault:CARD=gta04voice -fS16_LE -r8000 >/tmp/tam.wav	# modem -> earpiece, speaker, headset
			;;
	esac
done
echo "*** TAM done ***"
)

exit
